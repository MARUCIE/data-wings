# NL2SQL 技术 Spike - 基准报告

**日期**: 2025-01-28
**状态**: 框架就绪，待真实测试

---

## 1. Spike 目标

验证 Data Wings 核心 AI 能力 - 自然语言转 SQL（NL2SQL）的技术可行性。

## 2. 测试架构

```
┌─────────────────┐    ┌──────────────┐    ┌─────────────┐
│ 自然语言输入     │ -> │ NL2SQL Engine │ -> │ ClickHouse  │
│ "过去7天日活"    │    │ (LLM + Schema) │    │    SQL      │
└─────────────────┘    └──────────────┘    └─────────────┘
```

## 3. 测试用例覆盖

| 类别 | 用例数 | 场景 |
|------|--------|------|
| basic | 4 | 日活、PV、设备分布、渠道来源 |
| funnel | 2 | 注册转化、购物车漏斗 |
| retention | 2 | 7日留存、周留存趋势 |
| advanced | 3 | 收入分析、ARPU、高价值用户 |
| **总计** | **11** | |

## 4. 技术实现

### 4.1 LLM 选型

| 提供商 | 模型 | 优先级 | 说明 |
|--------|------|--------|------|
| DeepSeek | deepseek-chat | P1 | 国产首选，性价比高 |
| Qwen | qwen-max | P2 | 阿里云，国内访问稳定 |
| OpenAI | gpt-4o | P3 | 备选，准确率最高 |

### 4.2 Schema 映射策略

1. **完整 Schema 注入**: 将 events/users 表结构作为 System Prompt
2. **业务术语词典**: DAU/WAU/MAU/留存率等术语映射
3. **事件名称映射**: 中文事件名 -> 英文事件名

### 4.3 Prompt 工程

```
System Prompt:
├── 角色定义（SQL 专家）
├── Schema 文档（DDL + 示例查询）
├── 业务术语词典
├── 输出格式（JSON）
└── 注意事项

User Prompt:
├── 原始问题
└── 术语/事件名预处理结果
```

## 5. 性能基准（待测试）

| 指标 | 目标值 | 实测值 | 状态 |
|------|--------|--------|------|
| 准确率 | >= 80% | - | 待测试 |
| 延迟 P50 | < 2s | - | 待测试 |
| 延迟 P95 | < 5s | - | 待测试 |
| 平均置信度 | >= 0.85 | - | 待测试 |

## 6. 运行真实测试

```bash
# 1. 进入 spike 目录
cd spikes/nl2sql

# 2. 激活虚拟环境
source .venv/bin/activate

# 3. 设置 API Key
export DEEPSEEK_API_KEY=your_key

# 4. 运行测试
python test_queries.py
```

## 7. 技术决策（待确认）

### 7.1 模型选择

- [ ] DeepSeek 作为主 LLM（待验证准确率）
- [ ] 配置 LLM Router 支持降级

### 7.2 优化方向

- [ ] 增加 Few-shot 示例
- [ ] 扩展业务术语词典
- [ ] 添加查询结果缓存

### 7.3 风险点

| 风险 | 概率 | 影响 | 缓解 |
|------|------|------|------|
| 准确率不达标 | 中 | 高 | Few-shot + 反馈优化 |
| 延迟过高 | 低 | 中 | 缓存 + 异步 |
| LLM API 不稳定 | 低 | 高 | 多 LLM 降级 |

## 8. 下一步

1. **获取 DeepSeek API Key** 并运行真实测试
2. **记录测试结果** 到本报告
3. **根据结果决策** 是否进入开发阶段

---

猪哥云（四川）网络科技有限公司 | 合规网 www.hegui.com
猪哥云-数据产品部-Maurice | maurice_wen@proton.me
2025 猪哥云-灵阙企业级智能体平台
